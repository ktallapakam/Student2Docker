pipeline {
    agent any
    environment {
        IMAGE_NAME = 'devopskishore79/students'
    }

    stages {
        stage('Hello') {
            steps {
                echo 'Hello World.....!'
            }
        }
        stage('gitCheckout') {
            steps {
                echo 'Hello World.....gitCheckout'
                git branch: 'main', url: 'https://github.com/ktallapakam/Student2Docker.git'
            }
        }
        stage('gitBuild') {
            steps {
                echo 'Hello World.....gitBuild'
                sh 'mvn clean install'
            }
        }
        stage('dockerBuild') {
            steps {
                echo 'Hello World.....dockerBuild'
                sh 'docker build -t ${IMAGE_NAME} .'
            }
        }
        stage('ImageScan') {
            steps {
                echo 'Hello World.....DockerScan'
                // sh ''' trivy image --exit-code 1 --severity CRITICAL,HIGH --no-progress $IMAGE_NAME '''
                 sh 'trivy image ${IMAGE_NAME}:latest > report.txt'
            }
        }
        stage('dockerPush') {
            steps {
                echo 'Hello World.....dockerPush'
                withCredentials([string(credentialsId: 'dockerCred', variable: 'dockerCred')]) {
                    sh 'docker login -u devopskishore79 -p ${dockerCred}'
                }
                sh "docker push ${IMAGE_NAME}"
                echo 'Hello World....dockerpush...completed..!'
            }
        }
        echo "trivy scan added.."
    }
    stage('dockerPush') {
            steps {
                echo 'Hello World.....dockerPush'
                withCredentials([string(credentialsId: 'dockerCred', variable: 'dockerHubCred')]) {
                    sh 'docker login -u devopskishore79 -p ${dockerHubCred}'
                }
                sh 'docker push ${IMAGE_NAME}'
                echo "${IMAGE_NAME} pushed to dockerHub"
            }
        }


        post {
            success {
                mail to: 'dharshinivk30@gmail.com',
                    subject: "SUCCESS: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]'",
                    body: "Good news! Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]' completed successfully. \nCheck it here: ${env.BUILD_URL}"
            }
            failure {
                mail to: 'dharshinivk30@gmail.com',
                    subject: "FAILURE: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]'",
                    body: "Oops! Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]' has failed. \nCheck logs here: ${env.BUILD_URL}"
            }
        }
}
