pipeline {
    agent any
    environment {
        IMAGE_NAME = 'devopskishore79/students'
    }

    stages {
        stage('Hello') {
            steps {
                echo 'Hello World.....!'
            }
        }
        stage('gitCheckout') {
            steps {
                echo 'Hello World.....gitCheckout'
                git branch: 'main', url: 'https://github.com/ktallapakam/Student2Docker.git'
            }
        }
        stage('gitBuild') {
            steps {
                echo 'Hello World.....gitBuild'
                sh 'mvn clean install'
            }
        }
        stage('dockerBuild') {
            steps {
                echo 'Hello World.....dockerBuild'
                sh 'docker build -t ${IMAGE_NAME} .'
            }
        }
        stage('ImageScan') {
            steps {
                echo 'Hello World.....DockerScan'
                // sh ''' trivy image --exit-code 1 --severity CRITICAL,HIGH --no-progress $IMAGE_NAME '''
                 sh 'trivy image ${IMAGE_NAME}:latest > report.txt'
            }
        }
        stage('dockerPush') {
            steps {
                echo 'Hello World.....dockerPush'
                withCredentials([string(credentialsId: 'dockerCred', variable: 'dockerCred')]) {
                    sh 'docker login -u devopskishore79 -p ${dockerCred}'
                }
                sh "docker push ${IMAGE_NAME}"
                echo 'Hello World....dockerpush...completed..!'
            }
        }
        echo "webhook provided123"
    }
}
